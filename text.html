<article>
  <h1 id=text>Text</h1>

  <section>
    <h1 id=encoding>Encoding</h1>

    <p>An encoding is a mapping between byte sequences and characters<a
      href=#fn-encoding-dfn>†</a>. Each program source file,
    <code>String</code>, <code>Symbol</code>, <code>Regexp</code>, and
    <code>IO</code> object is, relatively independently, associated with its
    own encoding. Therefore, a program may consist of multiple source files,
    each associated with a different encoding, or concatenate two
    <code>String</code>s, one of which is encoded in <i>Windows-1250</i> and
    the other in <i>UTF-8</i>. The encoding of program source files, i.e.
    <dfn>source encoding</dfn>, was covered in the <a
      href=/programs>Programs</a> chapter. The encoding of
    <code>String</code>, <code>Symbol</code>, and <code>Regexp</code> objects
    is discussed in the respective section of this chapter. The <a
      href=/io>Input/Output</a> chapter deals with <code>IO</code> objects.</p>

    <section>
      <h1 id=encoding-class>The <code>Encoding</code> Class</h1>

      <p>Ruby represents the encodings that she understands as instances of
      the <code>Encoding</code> class, defining each as a constant under the
      <code>Encoding</code> namespace. The constant is named after the
      upper-case encoding name, with low lines replacing hyphen-minus
      characters. For example, <code>Encoding::UTF_8</code> or
      <code>Encoding::Windows_1250</code>. Given an encoding name as a
      <code>String</code>, the corresponding <code>Encoding</code> object may
      be retrieved with <code>Encoding.find(<var>name</var>)</code>.
      
      <p>A list of built-in encodings may be retrieved as an <code>Array</code>
      of <code>Encoding</code> objects with the <code>Encoding.list</code>
      method. <code>Encoding.aliases</code> returns a <code>Hash</code> whose
      keys are encoding aliases, and values are the corresponding built-in
      encoding. Methods that expect encodings as arguments accept instances of
      <code>Encoding</code>, or <code>String</code>s naming a built-in encoding
      or its alias. The <code>Encoding</code> object  associated with a
      <code>String</code>, <code>Symbol</code>, or <code>Regexp</code> is
      returned by their <code>#encoding</code> method.
    </section>
      
    <section>
      <h1 id=ascii-8bit>ASCII-8BIT</h1>

      <p>Ruby defines an encoding named <code>ASCII-8BIT</code>, with an alias
      of <code>BINARY</code>, which does not correspond to any known encoding.
      It is intended to be associated with binary data, such as the bytes that
      make up a <abbr title='Portable Network Graphics'>PNG</abbr> image, so
      has no restrictions on content. One byte always corresponds with one
      character.  This allows a <code>String</code> to be treated as <a
        href=#byte-array>bag of bytes</a> rather than a sequence of
      characters.  <code>ASCII-8BIT</code>, then, effectively corresponds to
      the absence of an encoding, so methods that expect an encoding name
      recognise <code>nil</code> as a synonym.
    </section>

    <section>
      <h1 id=encoding-compatibility>Compatibility</h1>

      <p>Methods of <code>String</code> and <code>Regexp</code> that take
      another such object as an argument require the encodings associated with
      the objects to be <dfn>compatible</dfn>. An encoding is always
      compatible with itself, so operations involving two objects associated
      with the same encoding are allowed. Likewise, two objects are compatible
      if they are both <a href=#ascii-only>ASCII-only</a>.

      <p>The compatibility of other combinations of encodings can be
      determined with <code>Encoding.compatible?</code>, which compares the
      encoding of its two arguments, which are either <code>Encoding</code>
      objects or objects associated with encodings. If they are compatible,
      the encoding which would result from their combination is returned;
      otherwise, <code>nil</code> results. Operating on objects with
      incompatible encodings causes an
      <code>Encoding::CompatibilityError</code> exception to be raised.
    </section>
  </section>
  
  <section>
    <h1 id=strings>Strings</h1>
     
    <p><code>String</code>s are mutable sequences of characters with an
    associated encoding. A <dfn>character</dfn> is a <code>String</code> with
    a <a href=#string-size>length</a> of 1: it may correspond to one byte in
    encodings such as <i>US-ASCII</i>, or a variable number of bytes in
    encodings such as <i>UTF-8</i>. In either case, it is the encoding which
    interprets a specific sequence of bytes as a character, and the encoding
    which specifies which character a given sequence of bytes represents.</p>

    <section>
      <h1 id=character>Character</h1>
    
      <figure class=railroad>
        <img id=character-literal.png>
        <figcaption>Syntax diagram of the character literal
      </figure>

      <p>A single character prefixed with a question mark
      (<code>?<var>char</var></code>) instantiates a <code>String</code>
      comprising the character.
    </section>
    
    <!-- TODO: alternative delimiters-->

    <section>
      <h1 id=single-quoted-strings>Single-Quoted Strings</h1>
      
      <figure class=railroad>
        <img id=single-quoted-string-literal.png>
        <figcaption>Syntax diagram of the single-quoted string literal
      </figure>
      
      <p>A single-quoted <code>String</code> is a string delimited by
      apostrophe (<code class=u title="'">U＋0027</code>) characters or
      <a href=#single-quoted-strings-q><code>%q</code></a>. Its contents
      are not subject to <a
        href=#string-interpolation>interpolation</a>. The only
      recognised <a href=#string-escapes>escape sequences</a> are
      <code>\\</code> and <code>\<var>delimiter</var></code>; any other
      escape is interpreted literally, i.e. as a reverse solidus
      followed by a single character.</p>
       
      <section>
        <h1 id=single-quoted-strings-q>Alternative Delimiters</h1>
        
        <figure class=railroad>
          <img id=single-quoted-string-literal-q.png>
          <figcaption>Syntax diagram of the <code>%q</code>
          single-quoted string literal
        </figure>
        
        <p>A single-quoted string may also be delimited by arbitrary
        delimiters with the
        <code>%q<var>delimiter</var>…<var>delimiter</var></code> construct,
        where <var>delimiter</var> is a single character.  If
        <var>delimiter</var> appears in the string it must be escaped.
        
        <p>If the opening delimiter is <code>(</code>, <code>[</code>,
        <code>&lt;</code>, or <code>{</code>, the closing delimiter must be
        the corresponding closing bracket. For example, if the opening
        delimiter is <code>[</code>, the closing delimiter must be
        <code>]</code>. When these paired delimiters are used, the same pair
        may appear inside the string as long as they are properly
        balanced.</p>
         
        <figure class=centre id=single-quoted-string-literal-q.rb>
          <figcaption>Constructing a single-quoted string with alternative
          delimiters using <code>%q</code>
        </figure>
      </section>
    </section>
    
    <section>
      <h1 id=double-quoted-strings>Double-Quoted Strings</h1>
      
      <figure class=railroad>
        <img id=double-quoted-string-literal.png>
        <figcaption>Syntax diagram of the double-quoted string literal
      </figure>
      
      <p>A double-quoted <code>String</code> is a <code>String</code>
      delimited with quotation marks (<code class=u
        title='"'>U＋0022</code>) characters or <a
        href=#double-quoted-strings-q><code>%Q</code></a>. Its contents
      are subject to <a href=#string-interpolation>interpolation</a> and
      <a href=#string-escapes>character escapes</a>.</p>
      
      <section>
        <h1 id=string-interpolation>String Interpolation</h1>
        
        <figure class=railroad>
          <img id=string-interpolation.png>
          <figcaption>Syntax diagram of the string interpolation
          construct
        </figure>
        
        <p><dfn title="string interpolation">Interpolation</dfn> is
        the embedding of the value of an expression within a string.
        The general form of the syntax is
        <code>#{<var>expression</var>}</code>.  It is common for
        <var>expression</var> to be simply the name of a local
        variable which is to be substituted for its value.
        
        <p>The braces can be omitted if <var>expression</var> is the
        name of a global—, class—, or instance variable. However, in
        this case the variable name cannot be immediately followed by
        a character legal in an identifier, as ambiguity results. </p>
      </section>

      <section>
        <h1 id=string-escapes>String Escapes</h1>
         
        <figure class=railroad>
          <img id=escape.png>
          <figcaption>Syntax diagram of the string escape
        </figure>
         
        <p><dfn title="backslash escape">Escape sequences</dfn> are
        character sequences prefixed with a reverse solidus (<code
          class=u title='\'>U＋005C</code>) that have a meaning other
        than their constituent characters.</p>
         
        <section>
          <h1 class=runout id=character-escapes>Character Escapes</h1>

          <figure class=railroad>
            <img id=character-escape.png>
            <figcaption>Syntax diagram of a character escape
          </figure>

          <p>A character escape consists of a reverse solidus followed by a
          single character, <var>char</var>. If <var>char</var> is one of
          [<code>abcefnrstuvxCM01234567</code>], the escape has the meaning
          given in the table below. If <var>char</var> is a literal <a
            href=/programs#newlines>line terminator</a>, both the reverse
          solidus and the line terminator are removed from the string. In all
          other cases <code>\<var>char</var></code> evaluates to
          <var>char</var>.</p>

          <figure class=centre id=character-escape.rb>
            <figcaption>A character escape is a reverse solidus followed by
            a single character
          </figure>
        </section>

        <section>
          <h1 id=byte-escapes>Byte Escapes</h1>

          <!-- intro para -->
          <p>&nbsp;</p>

          <figure class=railroad>
            <!-- TODO: Incorporate maximumn value of octal integer: 377
            -->
            <img id=byte-escape.png>
            <figcaption>Syntax diagram of the byte escape
          </figure>

          <section>
            <h1 id=octal-byte>Octal Byte Escapes</h1>

            <p>A reverse solidus followed by an octal number between zero
            and 377<sub>8</sub> represents the character whose character
            code that is.</p>

            <figure class=centre id=octal-byte-escape.rb>
              <figcaption>An octal byte escape consists of a backslash
              followed by a character code in base 8
            </figure>
          </section>

          <section>
            <h1 id=hex-byte>Hexadecimal Byte Escapes</h1>

            <p>A hexadecimal byte escape consists of <code>\x</code>
            followed by a hexadecimal number ≤ FF<sub>16</sub>. It
            represents the character whose code is given by the number.</p>

            <figure class=centre id=hex-byte-escape.rb>
              <figcaption>A hexadecimal byte escape consists of a backslash
              followed by an <code>x</code> followed by one or two
              hexadecimal digits
            </figure>
          </section>
        </section>

        <section>
          <h1 id=control-escapes class=runout>Control Escapes</h1>

          <figure class=railroad>
            <img id=control-escape.png>
            <figcaption>Syntax diagram for the control escape
          </figure>

          <p>The escape sequence for <a
            href=//en.wikipedia.org/wiki/Control_character>control
            character</a>
          <kbd><kbd>Ctrl</kbd>-<kbd><var>char</var></kbd></kbd> consists of a
          reverse solidus, either <code>c</code> or <code>C-</code>, then
          <var>char</var>, which may be a character or escape.
          (<var>char</var> must not be a <a href=#control-escape>control</a>,
          Unicode, <a href=#hex-byte>hexadecimal</a>, or three-digit <a
            href=#octal-byte>octal</a>, escape). Its value is the character
          whose character code is <var>char</var> ∧ 0x9F.</p>
          
          <figure class=centre id=control-escape.rb>
            <figcaption>The control escape represents a control key
          </figure>
        </section>

        <section>
          <h1 id=meta-escapes>Meta Character Escapes</h1>

          <figure class=railroad>
            <img id=meta-escape.png>
            <figcaption>Syntax diagram of the meta character escape
          </figure>

          <p>The meta character escape <code>\M-<var>char</var></code>
          represents the character whose character code is that of
          <var>char</var> ∨ 0x80, where <var>char</var> is a single
          character or escape. (<var>char</var> must not be a <a
          href=#meta-escape>meta character</a>, Unicode, <a
          href=#hex-byte>hexadecimal</a>, or three-digit <a
          href=#octal-byte>octal</a>, escape).</p>

          <figure class=centre id=meta-escape.rb>
            <figcaption>The meta character escape represents the given meta
            character.
          </figure>
        </section>

        <section>
          <h1 id=unicode-escapes>Unicode Escapes</h1>
             
          <figure class=railroad>
            <img id=unicode-escape.png>
            <figcaption>Syntax diagram of the Unicode <code>\u</code>
            escape
          </figure>
          
          <p>An arbitrary <a
          href=//en.wikipedia.org/wiki/Unicode>Unicode</a> character may be
          embedded in a string by specifying its <a
          href=//en.wikipedia.org/wiki/Codepoint>codepoint</a> as four
          hexadecimal digits following <code>\u</code>.            

          <p>The <code>\u{}</code> construct extends this ability to
          embedding multiple codepoints with the same escape.
          The curly braces delimit one or more hexadecimal codepoints
          separated by whitespace. This form does not restrict a
          codepoint to four digits.</p>             

          <figure class=railroad>
            <img id=hex-codepoint.png>
            <figcaption>Syntax diagram of a Unicode codepoint in hexadecimal
          </figure>

          <figure class=centre id=unicode-escape.rb>
            <figcaption>A Unicode escape represents a Unicode character with
            the given codepoint(s)
          </figure>
        </section>

        <table class=border>
          <thead>
            <tr><th>Escape Sequence<th>Interpretation
          </thead>
          <tbody>
            <tr class=odd>
              <td><code>\a</code>
                <td><code class=u>U＋0007</code>: The <a
                  href=//en.wikipedia.org/wiki/Bell_character>BEL</a>
                  character. Rings the console bell.
            <tr>
              <td><code>\b</code>
              <td><code class=u>U＋0008</code>: The <a
                  href=//en.wikipedia.org/wiki/Backspace>Backspace</a>
                character.
            <tr class=odd>
              <td><code>\e</code>
              <td><code class=u>U＋001B</code>: The <a
                  href=//en.wikipedia.org/wiki/Esc>ESC</a> character.
            <tr>
              <td><code>\f</code>
              <td><code class=u>U＋000C</code>: The <a
                  href=//en.wikipedia.org/wiki/Form_feed>Form Feed</a>
                character.
            <tr class=odd>
              <td><code>\n</code>
              <td><code class=u>U＋000A</code>: The <a
                  href=//en.wikipedia.org/wiki/Newline>Newline</a>
                character.
            <tr>
              <td><code>\r</code>
              <td><code class=u>U＋000D</code>: The <a
                  href=//en.wikipedia.org/wiki/Carriage_return>Carriage
                  Return</a> character.
            <tr class=odd>
              <td><code>\s</code>
              <td><code class=u title=' '>U＋0020</code>: The <a
                  href=//en.wikipedia.org/wiki/Space_key>Space</a>
                character.
            <tr>
              <td><code>\t</code>
              <td><code class=u>U＋0009</code>: The <a
                  href=//en.wikipedia.org/wiki/Tab_character>Tab</a>
                character
            <tr class=odd>
              <td><a
              href=#unicode-escapes><code>\u<var>hex</var><var>hex</var><var>hex</var><var>hex</var></code></a>
                <td>The Unicode codepoint specified by the four given
                hexadecimal digits.
            <tr>
              <td><a
              href=#unicode-escapes><code>\u{<var>codepoints</var>}</code></a>
              <td>The Unicode codepoint(s) specified by
                <a href=#unicode-escapes><var>codepoints</var></a>.
            <tr class=odd>
              <td><code>\v</code>
              <td><code class=u>U＋000B</code>: The vertical tab
                character.
            <tr>
              <td><a
              href=#octal-byte><code>\<var>octal</var><var>octal</var><var>octal</var></code></a>
              <td>The byte specified by the three given octal digits,
                whose combined value does not exceed 377<sub>8</sub>.
            <tr class=odd>
              <td><a
              href=#octal-byte><code>\<var>octal</var><var>octal</var></code></a>
              <td>The byte specified by the two given octal digits.
            <tr>
              <td><a href=#octal-byte><code>\<var>octal</var></code></a>
              <td>The byte specified by the given octal digit.
            <tr class=odd>
              <td><a
              href=#hex-byte><code>\x<var>hex</var><var>hex</var></code></a>
              <td>The byte specified by the two given hexadecimal
                digits.
            <tr>
              <td><a href=#hex-byte><code>\x<var>hex</var></code></a>
              <td>The byte specified by the given hexadecimal digit.
            <tr class=odd>
              <td><a
              href=#control-escapes><code>\c<var>char</var></code></a>
              <td rowspan=2>The control character
              <kbd><kbd>Ctrl</kbd>-<kbd><var>char</var></kbd></kbd>.
            <tr class=odd>
              <td><a
              href=#control-escapes><code>\C-<var>char</var></code></a>
            <tr>
              <td><a href=#meta-escapes><code>\M-<var>char</var></code></a>
              <td>Meta character <var>char</var>.
            <tr class=odd>
              <td><code>\</code><code class=u>U＋000A</code>
              <td rowspan=3>A backslash before a <a
                  href=//en.wikipedia.org/wiki/Newline>line terminator</a>
                escapes it, removing both the line
                terminator and backslash from the string
            <tr class=odd>
              <td><code>\</code><code class=u>U＋000D</code>
            <tr class=odd>
              <td><code>\</code>〈<code class=u>U＋000D</code>,&nbsp;<code
                  class=u>U＋000A</code>〉
            <tr>
              <td><code>\<var>char</var></code>
              <td>A backslash before any other character evaluates to
                the character itself
          </tbody>
        </table>
      </section>

      <section>
        <h1 id=double-quoted-strings-q>Alternative Delimiters</h1>
        
        <figure class=railroad>
          <img id=double-quoted-string-literal-q.png>
          <figcaption>Syntax diagram of the <code>%Q</code>
          double-quoted string literal
        </figure>
        
        <p>A double-quoted string may also be delimited by arbitrary
        delimiters with the
        <code>%Q<var>delimiter</var>…<var>delimiter</var></code> and
        <code>%<var>delimiter</var>…<var>delimiter</var></code>constructs,
        where <var>delimiter</var> is a single character.  If
        <var>delimiter</var> appears in the string it must be escaped.
         
        <p>If the opening delimiter is <code>(</code>, <code>[</code>,
        <code>&lt;</code>, or <code>{</code>, the closing delimiter
        must be the corresponding closing bracket. For example, if the
        opening delimiter is <code>[</code>, the closing delimiter
        must be <code>]</code>. When these paired delimiters are used,
        the same pair may appear inside the string as long as they are
        properly balanced.</p>
          
        <figure class=centre id=double-quoted-string-literal-q.rb>
          <figcaption>Constructing a double-quoted string with
          alternative delimiters using <code>%Q</code>
        </figure>
      </section>
    </section>
    
    <p>Therefore, a <dfn>string literal</dfn> is either a double-quoted
    string literal or a single-quoted string literal.</p>
    
    <figure class=railroad>
      <img id=string-literal.png>
      <figcaption>Syntax diagram of the string literal
    </figure>
     
    <section>
      <h1 id=here-documents>Here Documents</h1>
      
      <figure class=railroad>
        <img id=here-doc.png>
        <figcaption>Syntax diagram of the here document
      </figure>
       
      <p><dfn>Here documents</dfn> extend the concept of alternative
      delimiters to allow an arbitrary <em>sequence</em> of characters
      as a delimiter. They begin with <code>&lt;&lt;</code> followed
      immediately by an arbitary identifier or string literal. Their
      content begins on the following line and continues until that
      same identifier/string is seen on a line by itself with no
      intervening whitespace. If there is a hyphen between the
      opening <code>&lt;&lt;</code> and the delimiter, i.e.
      <code>&lt;&lt;-<var>delimiter</var></code>, the closing
      delimiter may be preceded with whitespace. The final newline
      character before the closing delimiter is part of the here
      document’s contents: a minimal here document is equivalent to
      <code>"\n"</code>.
      
      <p>If the delimiter is an identifier or double quoted string,
      the contents of the here document is interpreted with
      double-quoted string semantics. Otherwise, the here document’s
      contents are interpreted literally: all escape sequences and
      interpolation constructs are ignored.</p>
      
      <figure class=centre id=here-doc.rb>
        <figcaption>Using a here document to render a poem
      </figure>
    </section>

    <section>
      <h1 id=backticks>Backticks</h1>
        
      <p>A double-quoted string delimited with grave accents (<code
        class=u title='`'>U＋0060</code>) characters, or “backticks”,
      executes its contents as an operating system command and returns
      the output. This is achieved by the <code>Kernel.`</code> method,
      which can be redefined to alter these semantics. <!-- Note: only
      redefinable literal -->Alternative
      delimiters can be used with the corresponding
      <code>%x<var>delimiter</var>…<var>delimiter</var></code>
      construct, which follows the same rules as <a
        href=#double-quoted-strings-q><code>%Q</code></a>.</p>
      
      <figure class=centre id=backticks.rb>
        <figcaption>Using backticks to execute commands and retrieve
        the output
      </figure>
      <!-- Example: `df .`.split("\n")[1].split[4]
      => "55%" -->
    </section>

    <!-- TODO: Snip below paragraph? -->
    <p>A string may be iterated over by Unicode codepoint with
    <code>String#codepoints</code>, byte with <code>String#bytes</code>,
    character with <code>String#chars</code>, or line with
    <code>String#lines</code>.</p>

    <section>
      <h1 id=string-encoding>Encoding</h1>

      <p>The encoding of a <code>String</code> literal is normally that of the
      source file in which it appears. However, both forms of the Unicode
      escape sequence force the string in which they are embedded to have
      UTF-8 encoding. Therefore they are illegal in a file that has both a
      non-UTF-8 source encoding and a string containing literal multibyte
      characters in that encoding.</p>

      <!-- String#bytes to inspect encoding -->

      <section>
        <h1 id=string-transcode>Transcoding</h1>

        <p><dfn>Transcoding</dfn> a <code>String</code> converts its bytes to
        the equivalent byte sequences in a given encoding, then tags the new
        string with the new encoding. It is performed with
        <code>String#encode</code>, which returns its receiver transcoded from
        a <var>source</var> encoding to a <var>target</var> encoding.
        <code>String#encode!</code> operates in the same manner, but
        transcodes the receiver in-place.

        <p>By default, <var>source</var> is the receiver’s current encoding,
        and <var>target</var> is the default_internal encoding. When called
        with one encoding argument, this becomes the <var>target</var>
        encoding. When called with two encoding arguments, the first is the
        <var>target</var>, the second is the <var>source</var>. This last form
        is mainly useful when the <code>String</code> is tagged
        <code>ASCII-8BIT</code>: it associates the <code>String</code> with
        <var>source</var>, then transcodes from <var>source</var> to
        <var>target</var>.

        <p>If a character in the <code>String</code> does not exist in the
        <var>target</var> encoding, or the <code>String</code> contains
        bytes invalid in its current encoding, an exception is raised.
        This behaviour can be changed by supplying an <var>options</var>
        <code>Hash</code> as the final argument, whose form is described in
        the table that follows.</p>

        <table class=border>
          <caption>The keys and values that are recognised in the
            <var>options</var> <code>Hash</code> accepted by
            <code>String#encode</code> and <code>String#encode!</code>. The
            <i>Key</i> column names a key of the <code>Hash</code>, and the
            <i>Values</i> column specifies its possible values.
          <thead>
            <tr>
              <th>Key
              <th>Values
              <th>Description
          <tbody class=zebra>
            <tr>
              <td><code>:cr_newline</code>
              <td><code>true</code> or <code>false</code>
                <td>Whether to convert <code>\n</code> to <code>\r</code>.  
            <tr>
              <td><code>:crlf_newline</code>
              <td><code>true</code> or <code>false</code>
              <td>Whether to convert <code>\n</code> to <code>\r\n</code>.  
            <tr>
              <td><code>:invalid</code>
              <td><code>:replace</code> or <code>nil</code>
              <td>A value of <code>:replace</code> causes characters invalid
                in the source encoding to be substituted for the replacement
                string. A value of <code>nil</code>, which is the default,
                causes an <code>Encoding::InvalidByteSequenceError</code>
                exception to be raised in this scenario.
            <tr>
              <td><code>:replace</code>
              <td><code>String</code>
                <td>The <dfn>replacement string</dfn> used by the
                <code>:invalid</code> or <code>:undef</code> options. By
                default, it is <code class=u>U+FFFD</code> for Unicode
                encodings and <code>?</code> for others.
            <tr>
              <td><code>:undef</code>
              <td><code>:replace</code> or <code>nil</code>
              <td>A value of <code>:replace</code> causes characters invalid
                in the destination encoding to be substituted for the
                replacement string. A value of <code>nil</code>, which is the
                default, causes an
                <code>Encoding::UndefinedConversionError</code> exception to
                be raised in this scenario.
            <tr>
              <td><code>:universal_newline</code>
              <td><code>true</code> or <code>false</code>
              <td>When true, <code>\r\n</code> and <code>\r</code> are
                converted to <code>\n</code>.
            <tr>
              <td>:xml
              <td><code>:text</code> or <code>:attr</code>
              <td>Replaces <code>&amp;</code> with <code>&amp;amp;</code>,
                <code>&lt;</code> with <code>&amp;lt;</code>,
                <code>&gt;</code> with <code>&amp;gt;</code>, and undefined
                characters with a hexadecimal entity of the form
                <code>&amp;#x<var>hex</var>;</code>, where <var>hex</var> is
                a sequence of hexadecimal digits. In addition, when a value
                of <code>:attr</code> is supplied, <code>"</code> is
                replaced with <code>&amp;quot;</code>.
        </table>
        <!-- Advanced transcoding with Encoding::Converter -->
      </section>

      <section>
        <h1 id=string-encoding-tag>Tagging</h1>

        <p>The encoding associated with a <code>String</code> may be changed
        independently of its contents. This is necessary if the contents are
        valid in one encoding, but associated, or <dfn>tagged</dfn>, with
        another. Transcoding would be inappropriate because it would alter the
        underlying bytes, which are already perfectly valid. The solution is
        <code>String#force_encoding</code>, which tags its receiver with the
        encoding given as an argument. This operation will always succeed,
        even if the <code>String</code>’s contents are <a
          href=#valid-encoding>invalid</a> in the new encoding.

        <p>Two <code>String</code>s tagged with different encodings do not
        compare as equal even when they consist of identical byte sequences. 
      </section>

      <section>
        <h1 id=valid-encoding>Valid Encodings</h1>

        <p>A <code>String</code>’s encoding is <dfn title='valid
          encoding'>valid</dfn> if its constituent bytes are properly formed
        according to the encoding it is tagged with. In general, if you create
        a <code>String</code> via a literal, or consume a
        <code>String</code> as input that is validly encoded, manipulating it
        as a sequence of characters will ensure its encoding remains valid.
        However, tagging a <code>String</code> with an improper encoding,
        treating it as <a href=#byte-arrays>byte array</a>, or consuming
        garbage input, may all result in an invalid encoding. The
        <code>String#valid_encoding?</code> predicate returns
        <code>true</code> if the <code>String</code>’s encoding is valid;
        <code>false</code> otherwise.
      </section>

      <section>
        <h1 id=ascii-only>ASCII Only</h1>

        <p>Many operations on <code>String</code>s contain optimisations for
        <code>String</code>s that are <dfn>ASCII-only</dfn>-containing 7-bit
        ASCII characters exclusively-regardless of the associated encoding. We
        saw an example of this with <code>String</code> literals: they’re
        tagged with the source encoding by default, but downgrade to
        <i>US-ASCII</i> if the <code>String</code> is ASCII-only. Similarly,
        two <code>String</code>s with disparate encodings can be <a
          href=#encoding-compatibility>compatible</a> if they’re both
        ASCII-only. In general, however, these optimisations are transparent
        so can be safely ignored. The <code>String#ascii_only?</code>
        predicate can be useful if you wish to perform your own optimisations
        along these lines.
      </section>
    </section>

    <section>
      <h1 id=byte-arrays>Byte Arrays</h1>
      
      <p>A <code>String</code> may be treated as a sequence of bytes.
      <code>String#bytes</code> returns an <code>Enumerator</code> of its
      receiver’s bytes, represented as <code>Fixnum</code>s. A specific byte
      position may be assigned to with <code>String#setbyte(<var>index</var>,
        <var>byte</var>)</code>, where <var>index</var> is the zero-based offset
      of the byte to be changed, and <var>byte</var> is the new value as an
      <code>Integer</code>. A byte may be retrieved from a given offset with
      <code>String#getbyte(<var>index</var>)</code>.

      <p>Byte-level access generally assumes that the <code>String</code> is
      encoded in <a href=#ascii-8bit><i>ASCII-8BIT</i></a>; otherwise,
      modifying arbitrary bytes is liable to result in a <code>String</code>
      with an <a href=#valid-encoding>invalid encoding</a>.
    </section>

    <section>
      <h1 id=string-size>Size</h1>

      <p>“How long is a piece of string.” isn’t always a rhetorical question,
      but in Ruby the answer depends on your unit of measurement.
      <code>String#length</code> and <code>String#size</code>, which are
      aliases, return the number of characters in their receiver. Therefore,
      they are dependent on the associated encoding: the length of a
      <code>String</code> may change simply by tagging it with a different
      encoding. <code>String#bytesize</code>, however, returns the number of
      bytes contained in its receiver. It is unaffected by
      <code>String#force_encoding</code>.
    </section>
  </section>
      
  <section>
    <h1 id=regexps>Regexps</h1>
      
    <p>A <code>Regexp</code> represents a pattern that describes a
    <code>String</code>. It <i>matches</i> when contained by the former. The
    literal is of the form
    <code>/<var>pattern</var>/<var>options</var></code>: a pattern delimited
    by solidi, followed by zero or more option specifiers.</p>
    
    <!-- TODO: EBNF for regexp... -->
    <figure class=railroad>
      <img id=regexp-literal.png>
      <img style=float:left id=regexp-options.png>
      <figcaption>Syntax diagram of the regexp literal
    </figure>
    
    <p>The pattern consists of literal characters and meta-characters. A
    literal character is a non-meta-character; it matches itself. Prefixing a
    meta-character with a reverse solidus causes it to match literally.
    <!-- List the meta-characters explicitly? -->
    
    <p>A balanced pair of parentheses are meta-characters which group and/or
    capture the characters they enclose. Grouping allows the enclosed to be
    treated as an atomic whole such that meta-characters directly following
    the closing parenthesis act on the whole. Capturing is the extraction of
    specific parts of the text being matched so it can be referred to later,
    from within the pattern <!-- Mention backreferences? --> or the
    surrounding program. Parentheses do not capture if the opening parenthesis
    is directly followed by <code>?:</code>. Captures can be referred to by
    name if the opening parenthesis is followed by
    <code>?&lt;<var>name</var>&gt;</code>.  Alternatively, they can be
    referred to by number, where the <var>n</var><sup>th</sup> group of
    parentheses is numbered <var>n</var>.
    
    <p>A literal character or parenthetical may be followed by a quantifier
    meta-character which specifies how many consecutive occurrences are
    required at that point in the pattern. <code>+</code> requires at least
    one, <code>*</code> zero or more, and
    <code>{<var>min</var>,<var>max</var>}</code> between <var>min</var> and
    <var>max</var> times. <!-- Note that one of these can be omitted? -->
    
    <p>A character class specifies a set of characters, one of which must
    appear at that point in the pattern, enclosed within a pair of square
    brackets. The characters are specified literally, one after the other. A
    range of consecutive characters may be abbreviated with the notation
    <code><var>start</var>-<var>end</var></code>: the first character in the
    range separated from the last by a hyphen. Inside a character class the
    hyphen is therefore a metacharacter, so to be matched literally must
    appear immediately before the right square bracket.
    
    <p>There are pre-defined character classes to match alphabetical
    characters (<code>[[:alpha:]]</code>), lowercase
    (<code>[[:lower:]]</code>), uppercase (<code>[[:upper:]]</code>),
    alphanumerics (<code>[[:alnum:]]</code>), digits
    (<code>[[:digit:]]</code>), whitespace (<code>[[:space:]]</code>), and
    punctuation (<code>[[:punct:]]</code>), among others. The period matches
    any character except newline.
    
    <p>A vertical line is a meta-character specifying that either the
    expression to its right, or that to its left, must match. It is usually used
    inside a parenthetical.
    
    <p><code>String#match</code> returns a <code>MatchData</code> object if
    the match succeeded; <code>nil</code> otherwise. <code>MatchData#[]</code>
    returns the text captured by the capture group given as a
    <code>Symbol</code>, for a named group, or an <code>Integer</code>.
     
    <!-- String#gsub? -->
  </section>

  <section>
    <h1 id=symbols>Symbols</h1>

    <p>A <code>Symbol</code> represents a name.  <code>Symbol</code>s are
    immutable immediates. Two symbols with the same content will always be
    represented by the same object, e.g. <code>:glark.object_id ==
      :glark.object_id</code>, so symbol comparisons are extremely
    efficient.  However, <code>Symbol</code> objects are not
    garbage collected, so are unsuitable for storing data from unbounded
    collections; use <code>String</code>s instead.</p>
    
    <figure class='railroad sidenote'>
      <img id=symbol.png>
    </figure>

    <p><code>Symbol</code>s are used for unique identifiers, such
    as <code>Hash</code> keys, as message selectors and method
    names, and as a substitute for constants.

    <p>A symbol is an <a href=/programs#identifiers>identifier</a> or an <a
      href=/messages#operators>operator method selector</a>. A
    <code>Symbol</code> literal consists of a colon (<code class=u
      title=':'>U＋003A</code>) followed by an symbol or <code>String</code>
    literal, e.g.  <code>:roland_barthes</code> or
    <code>:'887'</code>. The
    <code>%s<var>delimiter</var>…<var>delimiter</var></code> construct
    enables symbols to be specified between arbitrary delimiters along the
    same lines as <a href=#single-quoted-strings-q><code>%q</code></a>.</p>

    <figure class='centre railroad'>
    <!-- TODO: Exclude \0 -->
      <!-- TODO: Look for other exceptions to this rule -->
      <img class=inline id=symbol-literal.png>
      <figcaption class=clear>Syntax diagram of the symbol literal
    </figure>

    <!-- #to_sym -->
  </section>

  <footer>
    <h1>Footnotes</h1>
    
    <ol>
      <li id=fn-encoding-dfn>In Unicode terminology, this encompasses both
      <abbr title='Character Encoding Scheme'>CES</abbr>s and <abbr
        title='Character Encoding Form'>CEF</abbr>s.
    </ol>
  </footer>
</article>
